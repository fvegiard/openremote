services:
  # Reverse proxy w/ Basic Auth for Vite frontend
  proxy:
    image: caddy:2
    ports:
      - "${PUBLIC_HTTP_PORT:-8080}:80"
    environment:
      BASIC_AUTH_USER: "${BASIC_AUTH_USER}"
      BASIC_AUTH_HASH: "${BASIC_AUTH_HASH}"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - ohmyopencode
    networks:
      - edge
      - internal

  # Dev container with SSH access and exposed vite dev frontend
  ohmyopencode:
    build: .
    ports:
      - "2222:22"  # SSH access
      - "5173:5173" # Vite dev server
    expose:
      - "5173"     # Vite dev server (accessed via proxy, not exposed to host)
    environment:
      GITHUB_REPO_URL: "${GITHUB_REPO_URL}"
      GITHUB_TOKEN: "${GITHUB_TOKEN}"
      # LLM Configuration
      LLM_MODEL: "${LLM_MODEL}"
      LLM_BASE_URL: "${LLM_BASE_URL}"
      LLM_API_KEY: "${LLM_API_KEY}"
      OPENAI_BASE_URL: "${OPENAI_BASE_URL}"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      # Cloud Providers
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      # MCP keys
      CONTEXT7_API_KEY: "${CONTEXT7_API_KEY}"
      # SSH Access
      SSH_PUBLIC_KEY: "${SSH_PUBLIC_KEY}"
      RALPH_SLACK_WEBHOOK_URL: "${RALPH_SLACK_WEBHOOK_URL}"
    volumes:
      - ./workspace:/workspace
    command: ["sleep", "infinity"]
    networks:
      - internal

  # Optional: Cloudflare Tunnel (recommended: no public inbound ports)
  cloudflared:
    image: cloudflare/cloudflared:latest
    profiles: ["tunnel"]
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    command: ["tunnel", "--protocol", "http2", "run"]
    depends_on:
      - proxy
    networks:
      - edge
      - internal

  # Devcontainer helper (keeps a container alive for VS Code attachment)
  devcontainer:
    build: .
    profiles: ["devcontainer"]
    command: ["sleep", "infinity"]
    volumes:
      - ./:/workspace
    networks:
      - internal

networks:
  edge: {}
  internal:
    # internal: true  <-- blocked internet access. Removed to allow outbound calls (plugins, LLMs).
    driver: bridge

volumes:
  ohmyopencode-config: {}
