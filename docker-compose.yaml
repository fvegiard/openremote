services:
  # Reverse proxy w/ Basic Auth in front of everything
  proxy:
    image: caddy:2
    ports:
      - "${PUBLIC_HTTP_PORT:-8080}:80"
    environment:
      BASIC_AUTH_USER: "${BASIC_AUTH_USER}"
      BASIC_AUTH_HASH: "${BASIC_AUTH_HASH}"
      ADMIN_AUTH_USER: "${ADMIN_AUTH_USER:-admin}"
      ADMIN_AUTH_HASH: "${ADMIN_AUTH_HASH:-}"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - ohmyopencode
      - terminal
    networks:
      - edge
      - internal

  # Oh-My-OpenCode web UI server (headless)
  ohmyopencode:
    build: .
    ports:
      - "2222:22"  # SSH access
    environment:
      OPENCODE_HOST: "0.0.0.0"
      OPENCODE_PORT: "4096"
      # Set this to your Cloudflare hostname (or leave empty if same-origin only)
      # OPENCODE_CORS: "https://code.yourdomain.com"
      GITHUB_REPO_URL: "${GITHUB_REPO_URL}"
      GITHUB_TOKEN: "${GITHUB_TOKEN}"
      # LLM Configuration
      LLM_MODEL: "${LLM_MODEL}"
      LLM_BASE_URL: "${LLM_BASE_URL}"
      LLM_API_KEY: "${LLM_API_KEY}"
      OPENAI_BASE_URL: "${OPENAI_BASE_URL}"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      # Cloud Providers
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY}"
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY}"
      # MCP keys
      CONTEXT7_API_KEY: "${CONTEXT7_API_KEY}"
      # SSH Access
      SSH_PUBLIC_KEY: "${SSH_PUBLIC_KEY}"
    volumes:
      - ./workspace:/workspace
    command: ["opencode-web"]
    networks:
      - internal

  # Web terminal (ttyd) in the same image/toolchain
  terminal:
    build: .
    environment:
      GITHUB_REPO_URL: "${GITHUB_REPO_URL}"
      GITHUB_TOKEN: "${GITHUB_TOKEN}"
    volumes:
      - ./workspace:/workspace
    command: ["ttyd", "-p", "7681", "-i", "0.0.0.0", "-W", "bash", "-lc", "cd /workspace && exec bash"]
    networks:
      - internal

  # Docker socket proxy for enhanced security
  socket-proxy:
    image: fluencelabs/docker-socket-proxy:1.1.0
    profiles: ["admin"]
    environment:
      - "LOG_LEVEL=info"
      # Grant access to all GET requests
      - "ALLOW_GET=1"
      # Grant access to events, used by Dockge to monitor container status
      - "EVENTS=1"
      # Grant access to specific POST requests required by Dockge
      - "POST=/containers/create,/containers/prune,/containers/start,/containers/stop,/containers/restart,/networks/create,/networks/prune,/volumes/create,/volumes/prune,/build"
      # Grant access to specific DELETE requests
      - "DELETE=/containers/(id),/networks/(id),/volumes/(id)"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - internal

  # Optional: "recreate / manage compose from web" (VERY powerful)
  # Dockge features include stack mgmt + web terminal. :contentReference[oaicite:0]{index=0}
  dockge:
    image: louislam/dockge:latest
    profiles: ["admin"]
    environment:
      DOCKGE_STACKS_DIR: /opt/stacks
      DOCKER_HOST: tcp://socket-proxy:2375
    volumes:
      - dockge-data:/app/data
      - dockge-stacks:/opt/stacks
    networks:
      - internal

  # Optional: Cloudflare Tunnel (recommended: no public inbound ports)
  cloudflared:
    image: cloudflare/cloudflared:latest
    profiles: ["tunnel"]
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    command: ["tunnel", "--protocol", "http2", "run"]
    depends_on:
      - proxy
    networks:
      - edge
      - internal

  # Devcontainer helper (keeps a container alive for VS Code attachment)
  devcontainer:
    build: .
    profiles: ["devcontainer"]
    command: ["sleep", "infinity"]
    volumes:
      - ./:/workspace
    networks:
      - internal

networks:
  edge: {}
  internal:
    # internal: true  <-- blocked internet access. Removed to allow outbound calls (plugins, LLMs).
    driver: bridge

volumes:
  ohmyopencode-config: {}
  dockge-data: {}
  dockge-stacks: {}
